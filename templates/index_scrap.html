<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestorPro: Advanced Stock Analysis Dashboard</title>

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50; /* Darker Slate Blue */
            --secondary-color: #34495e; /* Lighter Slate Blue */
            --accent-color: #1abc9c; /* Turquoise */
            --accent-hover-color: #16a085;
            --background-color: #ecf0f1; /* Light Gray */
            --card-background: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6, .navbar-brand, .card-header {
            font-family: 'Poppins', sans-serif;
            color: var(--heading-color);
        }

        .navbar {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 0.75rem 1.5rem; /* Increased padding */
        }

        .navbar-brand {
            color: #fff !important;
            font-weight: 700; /* Bolder */
            font-size: 1.5rem;
        }
        .navbar-brand i {
            color: var(--accent-color); /* Icon color */
        }

        .container-fluid {
            padding: 30px; /* More padding overall */
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px; /* Softer rounding */
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 25px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
             transform: translateY(-5px);
             box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background-color: var(--secondary-color);
            color: #fff;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important; /* Match card rounding */
            border-bottom: none;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
        }

        .card-body {
            padding: 1.5rem; /* More padding inside cards */
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25); /* Accent color focus */
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover-color);
            border-color: var(--accent-hover-color);
        }
        .btn-primary i {
            margin-right: 8px;
        }

        .stock-data-item {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically align items */
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color); /* Subtle separator */
            font-size: 0.95rem;
        }
        .stock-data-item:last-child {
            border-bottom: none;
        }

        .stock-data-label {
            font-weight: 500; /* Slightly bolder labels */
            color: var(--secondary-color);
            display: flex;
            align-items: center;
        }
        .stock-data-label i {
            margin-right: 8px;
            color: var(--accent-color); /* Icon color */
            width: 16px; /* Fixed width for alignment */
            text-align: center;
        }

        .stock-data-value {
            font-weight: 500;
        }

        /* Custom badge colors */
        .badge-success-custom {
            color: #fff;
            background-color: var(--success-color);
        }
        .badge-danger-custom {
            color: #fff;
            background-color: var(--danger-color);
        }
        .badge-warning-custom {
            color: var(--heading-color);
            background-color: var(--warning-color);
        }

        #loading {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 40px 20px;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent overlay */
            border-radius: 12px;
            position: absolute; /* Position relative to the column */
            top: 0;
            left: 15px; /* Account for col padding */
            right: 15px; /* Account for col padding */
            z-index: 10; /* Ensure it's on top */
        }
        .spinner-border {
            width: 3.5rem;
            height: 3.5rem;
            color: var(--primary-color);
        }
        #loading p {
            margin-top: 15px;
            font-weight: 500;
            color: var(--primary-color);
        }

        /* Enhanced styling for the GPT response content */
        .gpt-response {
            background-color: #f8f9fa; /* Light background for contrast */
            border-left: 5px solid var(--accent-color);
            padding: 25px; /* More padding */
            margin: 0; /* Remove default margin if applied */
            line-height: 1.7; /* Improve readability */
            border-radius: 0 0 12px 12px; /* Match card rounding at bottom */
        }

        /* Elegant and Simple Markdown to HTML Styling */

        .gpt-response .gpt-h1,
        .gpt-response .gpt-h2,
        .gpt-response .gpt-h3,
        .gpt-response .gpt-h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--heading-color);
            margin-top: 1.5em;
            margin-bottom: 0.6em;
            line-height: 1.3;
            font-weight: 600;
        }

        .gpt-response .gpt-h1 {
            font-size: 1.9rem; /* Slightly larger */
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.4em;
        }

        .gpt-response .gpt-h2 {
            font-size: 1.6rem; /* Slightly larger */
            border-bottom: 1px solid #ddd; /* Lighter border */
            padding-bottom: 0.3em;
        }

        .gpt-response .gpt-h3 {
            font-size: 1.3rem;
            color: var(--secondary-color); /* Slightly different color */
        }
        
        .gpt-response .gpt-h4 {
            font-size: 1.1rem;
            color: #555; /* Dark gray */
            font-weight: 500;
        }

        .gpt-response p {
            margin-bottom: 1em;
            color: #444; /* Softer text color */
        }

        .gpt-response .gpt-list {
            padding-left: 1.5rem; /* Standard indent */
            margin-bottom: 1em;
        }
        
        .gpt-response .gpt-list .gpt-list-item,
        .gpt-response .gpt-list li { /* Catchall for li not getting class */
            margin-bottom: 0.4em;
            padding: 0.2em 0; /* Minimal padding for list items */
            background-color: transparent !important; /* Override Bootstrap */
            border: none !important; /* Override Bootstrap */
            color: #444;
        }
        
        .gpt-response .gpt-ordered-list {
            list-style-type: decimal; /* Ensure ordered lists have numbers */
        }
        
        .gpt-response .gpt-list ul,
        .gpt-response .gpt-list ol {
            margin-top: 0.5em; /* Space before nested list */
            margin-bottom: 0.5em; /* Space after nested list */
        }

        .gpt-response .gpt-table {
            width: 100%;
            margin-bottom: 1.5em;
            border-collapse: collapse; /* Cleaner borders */
            font-size: 0.9rem; /* Slightly smaller table font */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .gpt-response .gpt-table th,
        .gpt-response .gpt-table td {
            border: 1px solid #e0e0e0; /* Lighter table borders */
            padding: 0.6em 0.8em; /* Consistent padding */
            text-align: left;
            vertical-align: top; /* Align content to top */
        }

        .gpt-response .gpt-table th {
            background-color: #f9f9f9; /* Very light gray for headers */
            font-weight: 600;
            color: var(--heading-color);
        }
        
        .gpt-response .gpt-table tr:nth-child(even) td {
            background-color: #fdfdfd; /* Subtle striping for rows */
        }

        .gpt-response .gpt-blockquote {
            border-left: 3px solid var(--accent-color);
            padding: 0.8em 1.2em;
            margin: 1.5em 0;
            background-color: #f5f7f9; /* Light background */
            color: #555;
            font-style: italic;
        }
        
        .gpt-response .gpt-blockquote p {
            margin-bottom: 0; /* No extra margin for paragraphs inside blockquote */
        }

        .gpt-response .gpt-code-block {
            background-color: #2d2d2d; /* Dark background for code blocks */
            color: #f8f8f2; /* Light text for contrast */
            padding: 1em;
            margin: 1.5em 0;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.85em; /* Slightly smaller for code */
            line-height: 1.5;
        }

        .gpt-response .gpt-code-block code {
            background-color: transparent; /* Code inside pre should not have its own bg */
            color: inherit;
            padding: 0;
            font-size: 1em; /* Inherit pre's font size */
        }

        .gpt-response .gpt-inline-code {
            background-color: #eef0f2; /* Light gray for inline code */
            color: #c7254e; /* Conventional color for inline code */
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.85em;
        }
        
        .gpt-response hr {
            border: 0;
            height: 1px;
            background-color: #ddd; /* Simple, thin horizontal rule */
            margin: 2em 0;
        }

        /* Specific card-like styling for sections */
        .gpt-response .gpt-section-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--shadow-color);
            margin-top: 2em;
            margin-bottom: 2em;
            overflow: hidden; /* To contain header and body */
        }

        .gpt-response .gpt-section-card-header {
            background-color: var(--secondary-color);
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 0.8em 1.2em;
            border-bottom: 1px solid var(--border-color);
        }

        .gpt-response .gpt-section-card-body {
            padding: 1.2em;
        }
        
        .gpt-response .gpt-section-card-body > *:first-child {
            margin-top: 0; /* Remove top margin from first element in card body */
        }
        .gpt-response .gpt-section-card-body > *:last-child {
            margin-bottom: 0; /* Remove bottom margin from last element in card body */
        }
        
        /* Financial metric and ticker styling */
        .gpt-response .financial-metric {
            font-family: 'Roboto Mono', monospace;
            font-weight: 500; /* Less bold */
            color: var(--accent-color);
            background-color: #eaf6f6; /* Lighter background */
            padding: 0.15em 0.35em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .gpt-response .stock-ticker code,
        .gpt-response .stock-ticker .gpt-inline-code { /* If ticker is already code */
            font-weight: 500;
            color: var(--primary-color);
            background-color: #e8ecf1;
            padding: 0.15em 0.35em;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        /* Remove default highlight styles if they are too aggressive */
        .gpt-response .highlight pre code span {
            /* Reset Pygments styles if they conflict with elegance */
            /* Example: color: inherit !important; background-color: transparent !important; */
        }
        
        /* Ensure that the general styles for h1-h3 in gpt-response are not overridden by overly specific old rules */
        .gpt-response h1, .gpt-response h2, .gpt-response h3, .gpt-response h4 {
            /* These are already defined above with .gpt-h1 etc. but this is a fallback */
            font-weight: 600; /* default from above */
            margin-top: 1.5em; /* default from above */
        }
        
        /* Clean up previous specific header stylings that might conflict */
        .gpt-response h1.text-primary.font-weight-bold,
        .gpt-response h2.text-secondary.font-weight-bold,
        .gpt-response h3.text-info.font-weight-bold {
            /* These styles will be handled by .gpt-h1, .gpt-h2, .gpt-h3 */
            /* Resetting them here if they are still applied by postprocess_html too aggressively */
        }
        
        /* Ensure .gpt-response tables don't inherit overly complex styles from general table CSS */
        .gpt-response table.table-striped, .gpt-response table.table-bordered {
            /* These will be handled by .gpt-table */
        }
        
        /* Remove conflicting styles if any */
        .gpt-response .section-header,
        .gpt-response .financial-header {
            /* These were older attempts, ensure they don't conflict with gpt-h1/h2/h3 etc. */
            border-bottom: none; /* Reset if they add extra borders */
            padding-bottom: 0;
            margin-bottom: 0.6em; /* Align with new h styles */
            background-color: transparent;
            box-shadow: none;
        }

        .gpt-response ul, .gpt-response ol {
            padding-left: 2rem; /* Ensure this overrides Bootstrap defaults if necessary */
        }
        .gpt-response li.list-group-item { /* This was from Bootstrap, ensure custom styles take over */
            padding: 0.2em 0 !important;
            margin-bottom: 0.4em !important;
            background-color: transparent !important;
            border: none !important;
        }
        .gpt-response ul.list-group { /* This was from Bootstrap */
            padding-left: 1.5rem !important; /* Custom padding for gpt-list */
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            .container-fluid {
                padding: 15px;
            }
            .card-body {
                padding: 1rem;
            }
             .stock-data-item {
                 flex-direction: column; /* Stack label and value on small screens */
                 align-items: flex-start;
                 border-bottom: 1px solid var(--border-color);
                 padding-bottom: 10px;
                 margin-bottom: 10px;
             }
             .stock-data-label {
                 margin-bottom: 5px;
             }
             .stock-data-value {
                 align-self: flex-end; /* Push value to the right */
             }
            .gpt-response {
                padding: 15px;
            }
        }

        .watermark {
            position: fixed;
            bottom: 10pt;
            right: 10pt;
            opacity: 0.5;
            z-index: -1000;
            font-size: 8pt;
            color: #ccc;
        }

        /* Download container styling */
        .download-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            border: 1px solid #e1e5ea;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .download-container:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .download-container .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 12px 24px;
        }
        
        .download-container .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .download-container i.fas {
            font-size: 1.2em;
        }
        
        /* GPT response styling */

        /* Add syntax highlighting styles for the GPT response */
        .gpt-response .highlight {
            background: transparent;
            border: none;
        }

        .gpt-response pre {
            white-space: pre-wrap;
            background-color: #ffffff;
            border: none;
            padding: 0;
            margin: 0;
        }

        /* Syntax highlighting colors */
        .gpt-response .gh { /* Headers */ 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #1a5276; 
            margin-top: 1.5rem;
        }

        .gpt-response .gu { /* Sub-headers */
            font-size: 1.25rem;
            font-weight: bold;
            color: #2874a6;
            margin-top: 1rem;
        }

        .gpt-response .gs { /* Strong/Bold */
            font-weight: bold;
            color: #145a32;
        }

        .gpt-response .ge { /* Emphasis/Italic */
            font-style: italic;
        }

        .gpt-response .k { /* Bullet points */
            color: #212f3d;
        }

        .gpt-response .w { /* Whitespace - keep as-is */
            color: inherit;
        }

        .gpt-response .financial-metric {
            font-weight: bold;
            color: #2e86c1;
            background-color: #f4f6f7;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
        }

        .gpt-response code {
            background-color: #f8f9fa;
            color: #c0392b;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: monospace;
        }

        .gpt-response .badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 85%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .gpt-response .badge-primary {
            color: #fff;
            background-color: #007bff;
        }

        /* Table formatting fixes */
        .gpt-response tr, .gpt-response td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        /* Fix for enhanced display of stock analysis */
        .gpt-response {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="#">
            <i class="fas fa-chart-line mr-2"></i>InvestorPro
        </a>
        </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-4 mb-4 mb-lg-0">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-search-dollar mr-2"></i>Stock Analysis Input
                    </div>
                    <div class="card-body">
                        <form method="post" id="stock-form">
                            <div class="form-group">
                                <label for="stock" class="font-weight-bold">Enter Stock Symbol:</label>
                                <input type="text" id="stock" name="stock" class="form-control form-control-lg" placeholder="e.g., AAPL, GOOGL" required>
                                <small class="form-text text-muted">Enter the ticker symbol of the stock you want to analyze.</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block btn-lg mt-3">
                                <i class="fas fa-cogs"></i>Analyze Stock
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div id="loading">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Crunching the numbers... Please wait.</p>
                </div>

                {% if stock_data %}
                <div class="card mb-4">
                    <div class="card-header">
                         <i class="fas fa-poll mr-2"></i>Analysis Results for {{ stock | upper }}
                    </div>
                    <div class="card-body">

                        {% if stock_data.real_price_data %}
                        <h5 class="mb-3"><i class="fas fa-balance-scale-right mr-2 text-primary"></i>Comprehensive Valuation Analysis</h5>
                        <div class="valuation-chart-container text-center mb-4">
                            <img src="/real_price_chart/{{ stock }}" alt="Real Price Chart for {{ stock | upper }}" class="img-fluid">
                        </div>

                        <div class="row valuation-summary">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-bullseye"></i>Weighted Fair Value:</span>
                                    <span class="stock-data-value font-weight-bold">${{ "%.2f"|format(stock_data.real_price_data.weighted_fair_value) }}</span>
                                </div>
                            </div>
                             <div class="col-md-6">
                                 <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-arrows-alt-h"></i>Current vs Fair Value:</span>
                                    <span class="stock-data-value">
                                        {% if stock_data.real_price_data.has_valuation_methods %}
                                            {% set diff = stock_data.real_price_data.price_difference %}
                                            <span class="badge {{ 'badge-danger-custom' if diff > 5 else ('badge-success-custom' if diff < -5 else 'badge-warning-custom') }} p-2">
                                                {{ "%.2f"|format(diff) }}%
                                                {% if diff > 5 %} Overvalued {% elif diff < -5 %} Undervalued {% else %} Fairly Valued {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary p-2">N/A</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {% if 'error_message' in stock_data.real_price_data %}
                        <div class="alert alert-warning mt-3 small">
                            <i class="fas fa-exclamation-triangle mr-2"></i><strong>Note:</strong> Limited valuation data. {{ stock_data.real_price_data.error_message }}
                        </div>
                        {% endif %}

                        {% if stock_data.real_price_data.has_valuation_methods %}
                        <div class="mt-4">
                            <h6><i class="fas fa-calculator mr-2 text-secondary"></i>Valuation Method Breakdown</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover table-bordered" style="font-size: 0.9rem;">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Method</th>
                                            <th>Fair Value ($)</th>
                                            <th>Weight (%)</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for method, data in stock_data.real_price_data.method_valuations.items() %}
                                        <tr>
                                            <td><strong>{{ method | upper }}</strong></td>
                                            <td>{{ "%.2f"|format(data.value) }}</td>
                                            <td>{{ "%.0f"|format(data.weight * 100) }}%</td>
                                            <td>
                                                {% if method == 'dcf' %}Discounted Cash Flow{% endif %}
                                                {% if method == 'pe' %}Price-to-Earnings Comparison{% endif %}
                                                {% if method == 'book' %}Book Value (Tangible Assets){% endif %}
                                                {% if method == 'dividend' %}Dividend Discount Model{% endif %}
                                                {% if method == 'relative' %}Market Price Benchmark{% endif %}
                                                </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info mt-3 small">
                             <i class="fas fa-info-circle mr-2"></i><strong>Note:</strong> Intrinsic value calculation requires more financial data than available for {{ stock | upper }}. Chart shows historical price only.
                        </div>
                        {% endif %}
                        <hr class="my-4">
                        {% endif %}

                        <h5 class="mb-3"><i class="fas fa-chart-area mr-2 text-primary"></i>Technical Indicators</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-dollar-sign"></i>Current Price:</span>
                                    <span class="stock-data-value">${{ "%.2f"|format(stock_data.current_price) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-arrow-up"></i>52-Week High:</span>
                                    <span class="stock-data-value">${{ "%.2f"|format(stock_data.high_52week) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-arrow-down"></i>52-Week Low:</span>
                                    <span class="stock-data-value">${{ "%.2f"|format(stock_data.low_52week) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-wave-square"></i>50-Day MA:</span>
                                    <span class="stock-data-value">${{ "%.2f"|format(stock_data.ma_50) }}</span>
                                </div>
                             </div>
                            <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-wave-square"></i>200-Day MA:</span>
                                    <span class="stock-data-value">${{ "%.2f"|format(stock_data.ma_200) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-tachometer-alt"></i>RSI (14-day):</span>
                                    <span class="stock-data-value">{{ "%.2f"|format(stock_data.rsi) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-chart-line"></i>MACD:</span>
                                    <span class="stock-data-value">{{ "%.2f"|format(stock_data.macd) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-signal"></i>MACD Signal:</span>
                                    <span class="stock-data-value">{{ "%.2f"|format(stock_data.macd_signal) }}</span>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3"><i class="fas fa-sliders-h mr-2 text-primary"></i>Volume Analysis</h5>
                         <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-chart-bar"></i>Current Volume:</span>
                                    <span class="stock-data-value">{{ "{:,}".format(stock_data.volume) }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-history"></i>Average Volume:</span>
                                    <span class="stock-data-value">{{ "{:,.0f}".format(stock_data.avg_volume) }}</span>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3"><i class="fas fa-building mr-2 text-primary"></i>Fundamental Analysis</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-coins"></i>Market Cap:</span>
                                    <span class="stock-data-value">${{ "{:,}".format(stock_data.market_cap) }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-percentage"></i>P/E Ratio:</span>
                                    <span class="stock-data-value">{{ stock_data.pe_ratio if stock_data.pe_ratio != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-long-arrow-alt-right"></i>Forward P/E:</span>
                                    <span class="stock-data-value">{{ stock_data.forward_pe if stock_data.forward_pe != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-chart-pie"></i>PEG Ratio:</span>
                                    <span class="stock-data-value">{{ stock_data.peg_ratio if stock_data.peg_ratio != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-exchange-alt"></i>Beta:</span>
                                    <span class="stock-data-value">{{ stock_data.beta if stock_data.beta != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-hand-holding-usd"></i>Dividend Yield:</span>
                                    <span class="stock-data-value">{{ stock_data.dividend_yield if stock_data.dividend_yield != 'N/A' else 'N/A' }}</span>
                                </div>
                             </div>
                             <div class="col-md-6">
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-sort-amount-up-alt"></i>Earnings Growth:</span>
                                    <span class="stock-data-value">{{ stock_data.earnings_growth if stock_data.earnings_growth != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-sort-amount-up"></i>Revenue Growth:</span>
                                    <span class="stock-data-value">{{ stock_data.revenue_growth if stock_data.revenue_growth != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-piggy-bank"></i>Profit Margins:</span>
                                    <span class="stock-data-value">{{ stock_data.profit_margins if stock_data.profit_margins != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-balance-scale-left"></i>Debt to Equity:</span>
                                    <span class="stock-data-value">{{ stock_data.debt_to_equity if stock_data.debt_to_equity != 'N/A' else 'N/A' }}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-wallet"></i>Free Cash Flow:</span>
                                    <span class="stock-data-value">{% if stock_data.free_cash_flow != 'N/A' %}${{ "{:,}".format(stock_data.free_cash_flow) }}{% else %}N/A{% endif %}</span>
                                </div>
                                <div class="stock-data-item">
                                    <span class="stock-data-label"><i class="fas fa-book"></i>Price to Book:</span>
                                    <span class="stock-data-value">{{ stock_data.price_to_book if stock_data.price_to_book != 'N/A' else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if stock %}
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-chart-line"></i> {{ stock }} Analysis
                                </div>
                                <div class="card-body">
                                    <div class="download-container mb-4 text-center p-3 bg-light rounded">
                                        <h5 class="mb-2"><i class="fas fa-download text-primary"></i> Download Your Analysis</h5>
                                        <p class="small text-muted mb-3">Get this complete analysis in a well-formatted document for offline viewing, printing or sharing</p>
                                        <a href="/download_pdf/{{ stock }}" class="btn btn-lg btn-primary shadow-sm">
                                            <i class="fas fa-file-pdf mr-2"></i> Download PDF Report
                                        </a>
                                    </div>
                                    
                                    <!-- New features panel -->
                                    <div class="row">
                                        <!-- Sentiment Analysis -->
                                        {% if stock_data.sentiment and stock_data.sentiment.success %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-header bg-info text-white">
                                                    <i class="fas fa-newspaper"></i> Sentiment Analysis
                                                </div>
                                                <div class="card-body">
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-chart-bar"></i> Overall Sentiment
                                                        </div>
                                                        <div class="stock-data-value">
                                                            <span class="badge 
                                                                {% if stock_data.sentiment.sentiment_label == 'Positive' %}
                                                                    badge-success-custom
                                                                {% elif stock_data.sentiment.sentiment_label == 'Negative' %}
                                                                    badge-danger-custom
                                                                {% else %}
                                                                    badge-warning-custom
                                                                {% endif %}">
                                                                {{ stock_data.sentiment.sentiment_label }}
                                                                ({{ stock_data.sentiment.sentiment_score|round(2) }})
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-list-alt"></i> News Count
                                                        </div>
                                                        <div class="stock-data-value">
                                                            {{ stock_data.sentiment.news_count }}
                                                        </div>
                                                    </div>
                                                    
                                                    {% if stock_data.sentiment.news %}
                                                    <div class="mt-3">
                                                        <h6>Recent Headlines</h6>
                                                        <ul class="list-group">
                                                            {% for news in stock_data.sentiment.news[:3] %}
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                {{ news.headline[:50] }}{% if news.headline|length > 50 %}...{% endif %}
                                                                <span class="badge 
                                                                    {% if news.sentiment_label == 'Positive' %}
                                                                        badge-success-custom
                                                                    {% elif news.sentiment_label == 'Negative' %}
                                                                        badge-danger-custom
                                                                    {% else %}
                                                                        badge-warning-custom
                                                                    {% endif %}">
                                                                    {{ news.sentiment_label }}
                                                                </span>
                                                            </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Technical Indicators -->
                                        {% if stock_data.technical_indicators and stock_data.technical_indicators.success %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="fas fa-chart-line"></i> Technical Signals
                                                </div>
                                                <div class="card-body">
                                                    {% if stock_data.technical_indicators.overall_signal %}
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-signal"></i> Overall Signal
                                                        </div>
                                                        <div class="stock-data-value">
                                                            <span class="badge 
                                                                {% if stock_data.technical_indicators.overall_signal.signal == 'bullish' %}
                                                                    badge-success-custom
                                                                {% elif stock_data.technical_indicators.overall_signal.signal == 'bearish' %}
                                                                    badge-danger-custom
                                                                {% else %}
                                                                    badge-warning-custom
                                                                {% endif %}">
                                                                {{ stock_data.technical_indicators.overall_signal.signal|upper }}
                                                                ({{ stock_data.technical_indicators.overall_signal.strength }})
                                                            </span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if stock_data.technical_indicators.support_levels %}
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-arrow-up"></i> Support Levels
                                                        </div>
                                                        <div class="stock-data-value">
                                                            {% for level in stock_data.technical_indicators.support_levels[:3] %}
                                                            <span class="badge badge-info">${{ level|round(2) }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if stock_data.technical_indicators.resistance_levels %}
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-arrow-down"></i> Resistance Levels
                                                        </div>
                                                        <div class="stock-data-value">
                                                            {% for level in stock_data.technical_indicators.resistance_levels[:3] %}
                                                            <span class="badge badge-info">${{ level|round(2) }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if stock_data.technical_indicators.signals %}
                                                    <div class="mt-3">
                                                        <h6>Latest Signals</h6>
                                                        <ul class="list-group">
                                                            {% for signal in stock_data.technical_indicators.signals[:3] %}
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                {{ signal.indicator }}
                                                                <span class="badge 
                                                                    {% if signal.signal == 'bullish' %}
                                                                        badge-success-custom
                                                                    {% elif signal.signal == 'bearish' %}
                                                                        badge-danger-custom
                                                                    {% else %}
                                                                        badge-warning-custom
                                                                    {% endif %}">
                                                                    {{ signal.signal|upper }}
                                                                </span>
                                                            </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Sector Analysis -->
                                        {% if stock_data.sector_comparison and stock_data.sector_comparison.success %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-header bg-secondary text-white">
                                                    <i class="fas fa-industry"></i> Sector Analysis
                                                </div>
                                                <div class="card-body">
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-building"></i> Sector
                                                        </div>
                                                        <div class="stock-data-value">
                                                            {{ stock_data.sector_comparison.sector }}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="stock-data-item">
                                                        <div class="stock-data-label">
                                                            <i class="fas fa-tag"></i> Industry
                                                        </div>
                                                        <div class="stock-data-value">
                                                            {{ stock_data.sector_comparison.industry }}
                                                        </div>
                                                    </div>
                                                    
                                                    {% if stock_data.sector_comparison.peers %}
                                                    <div class="mt-3">
                                                        <h6>Peer Comparison</h6>
                                                        <ul class="list-group">
                                                            {% for peer in stock_data.sector_comparison.peers[:3] %}
                                                            <li class="list-group-item small">
                                                                <strong>{{ peer.name }}</strong> ({{ peer.symbol }})
                                                                <div>PE: {{ peer.pe_ratio|round(2) if peer.pe_ratio else 'N/A' }}</div>
                                                                <div>Price: ${{ peer.current_price|round(2) if peer.current_price else 'N/A' }}</div>
                                                            </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if gpt_response %}
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-robot mr-2"></i>AI-Powered Insights & Trading Plan
                    </div>
                    <div class="gpt-response">
                        {{ gpt_response | safe }}
                    </div>
                </div>
                {% endif %}
            </div> </div> </div> <footer class="text-center py-4 mt-4">
            <small class="text-muted">&copy; {{ now.year }} InvestorPro. Financial data provided for informational purposes only.</small>
            </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // Show loading indicator on form submit
            $('#stock-form').on('submit', function() {
                $('#loading').fadeIn('fast'); // Use fadeIn for smoother appearance
                 // Optional: Hide previous results immediately
                 $('.card.mb-4').not(':first').hide(); // Hide results cards
                 $('.card:has(.gpt-response)').hide(); // Hide AI card
            });

            // Hide loading indicator if the page loads with results already
            if ($('.card-body').length > 1) { // Check if result cards exist
                $('#loading').hide();
            }
            
            // Enhanced formatting for stock analysis
            if ($('.gpt-response').length) {
                enhanceStockAnalysisFormatting();
            }
        });
        
        // Function to enhance stock analysis formatting
        function enhanceStockAnalysisFormatting() {
            var gptResponse = $('.gpt-response');
            
            // Check if the response contains syntax-highlighted code or markdown
            var hasSyntaxHighlighting = gptResponse.find('.highlight').length > 0;
            
            // If we have a highlighted code block, make sure code is properly styled
            if (hasSyntaxHighlighting) {
                // Find all code blocks and apply proper styling
                gptResponse.find('.highlight').each(function() {
                    $(this).css({
                        'background': 'transparent',
                        'border': 'none'
                    });
                    
                    $(this).find('pre').css({
                        'white-space': 'pre-wrap',
                        'background-color': '#ffffff',
                        'border': 'none',
                        'padding': '0',
                        'margin': '0'
                    });
                });
                
                // Properly style any tables inside the response
                gptResponse.find('table').each(function() {
                    if (!$(this).hasClass('table')) {
                        $(this).addClass('table table-striped table-bordered');
                    }
                });
                
                // Make sure any badges are properly styled
                gptResponse.find('.badge').each(function() {
                    $(this).css({
                        'display': 'inline-block',
                        'padding': '0.2em 0.6em',
                        'font-size': '85%',
                        'font-weight': '700',
                        'line-height': '1',
                        'text-align': 'center',
                        'white-space': 'nowrap',
                        'vertical-align': 'baseline',
                        'border-radius': '0.25rem'
                    });
                    
                    if ($(this).hasClass('badge-primary')) {
                        $(this).css({
                            'color': '#fff',
                            'background-color': '#007bff'
                        });
                    }
                });
            }
            
            // Handle header formatting better - add section classes
            gptResponse.find('h1, h2, h3').each(function() {
                var header = $(this);
                var text = header.text();
                
                // Check if the header contains section numbers like "1. VALUATION SUMMARY"
                if (/^\d+\.\s+/.test(text)) {
                    header.addClass('section-header');
                }
                
                // Format headers with financial terms
                if (/VALUATION|SUMMARY|ANALYSIS|STRATEGY|OUTLOOK|OVERVIEW|TECHNICAL|FUNDAMENTAL|TRADING PLAN/i.test(text)) {
                    header.addClass('financial-header');
                }
                
                // Add anchors to headers for navigation
                var id = text.toLowerCase().replace(/[^\w]+/g, '-');
                if (id && !header.attr('id')) {
                    header.attr('id', id);
                }
            });
            
            // Fix nested list styling
            gptResponse.find('ul, ol').each(function() {
                var list = $(this);
                if (list.parent().is('li')) {
                    list.removeClass('list-group').addClass('nested-list');
                    list.find('li').removeClass('list-group-item').addClass('nested-list-item');
                }
            });
            
            // Format dollar amounts and percentages in text
            gptResponse.find('p, li, td').each(function() {
                var element = $(this);
                var html = element.html();
                
                // Format dollar amounts ($XX.XX)
                html = html.replace(/(\$\d+(\.\d+)?)/g, '<span class="stock-data"><span class="price">$1</span></span>');
                
                // Format percentages with + or - sign
                html = html.replace(/(\+\d+(\.\d+)?%)/g, '<span class="stock-data"><span class="percentage percentage-positive">$1</span></span>');
                html = html.replace(/(\-\d+(\.\d+)?%)/g, '<span class="stock-data"><span class="percentage percentage-negative">$1</span></span>');
                
                element.html(html);
            });
            
            // Format stock tickers (uppercase letters in parentheses) 
            gptResponse.find('p, li, td').each(function() {
                var element = $(this);
                var html = element.html();
                
                // Match patterns like (AAPL) or (GOOG)
                html = html.replace(/\(([A-Z]{1,5})\)/g, '(<code>$1</code>)');
                
                element.html(html);
            });
            
            // Add structure to key-value pairs often found in financial analysis
            gptResponse.find('p, li').each(function() {
                var element = $(this);
                var text = element.text();
                
                // Match patterns like "Key: Value" common in stock reports
                if (/^([^:]+):\s+(.+)$/.test(text)) {
                    var html = element.html();
                    html = html.replace(/^([^:]+):\s+/, '<strong>$1:</strong> ');
                    element.html(html);
                }
            });
            
            // Fix any remaining tables
            gptResponse.find('table').each(function() {
                var table = $(this);
                if (!table.hasClass('table')) {
                    table.addClass('table table-striped table-bordered');
                }
                
                // Make sure table is properly contained
                if (!table.parent().is('div.table-responsive')) {
                    table.wrap('<div class="table-responsive"></div>');
                }
            });
            
            // Add spacing between sections
            gptResponse.find('h2').each(function() {
                var header = $(this);
                // Add a horizontal rule before each major section unless it's the first section
                if (!header.prev().is('h1')) {
                    header.before('<hr class="my-4">');
                }
            });
            
            // Create a table of contents from h2 headers if there are more than 3 sections
            var h2Headers = gptResponse.find('h2');
            if (h2Headers.length >= 3) {
                var tocHtml = '<div class="card mb-4"><div class="card-header bg-light">' +
                              '<strong>Table of Contents</strong></div><div class="card-body p-0">' +
                              '<ul class="list-group list-group-flush toc-list">';
                
                h2Headers.each(function() {
                    var header = $(this);
                    var id = header.attr('id') || '';
                    var text = header.text();
                    
                    tocHtml += '<li class="list-group-item border-0 py-2">' +
                              '<a href="#' + id + '" class="text-decoration-none">' + text + '</a></li>';
                });
                
                tocHtml += '</ul></div></div>';
                
                // Insert the TOC after the first heading
                var firstHeading = gptResponse.find('h1, h2').first();
                firstHeading.after(tocHtml);
            }
            
            // Format financial terms consistently
            var financialTerms = [
                'P/E', 'EPS', 'EBITDA', 'ROE', 'ROI', 'ROA', 'P/B', 'PEG', 'DCF', 
                'WACC', 'FCF', 'CAGR', 'YoY', 'QoQ', 'TTM'
            ];
            
            financialTerms.forEach(function(term) {
                gptResponse.find('p, li, td').each(function() {
                    var element = $(this);
                    var html = element.html();
                    
                    var regex = new RegExp('\\b' + term + '\\b', 'g');
                    html = html.replace(regex, '<span class="financial-metric">' + term + '</span>');
                    
                    element.html(html);
                });
            });
            
            // Add target="_blank" to external links
            gptResponse.find('a[href^="http"]').attr('target', '_blank').attr('rel', 'noopener noreferrer');
        }
    </script>
</body>
</html>